{% extends 'base.html' %}

{% block title %}Dashboard - Log Anomaly Detection Platform{% endblock %}

{% block page_title %}Dashboard Overview{% endblock %}

{% block content %}
<!-- Summary Cards with Modern Design -->
<div class="row g-4 mb-5">
    <div class="col-xl-4 col-md-6">
        <div class="stat-card stat-card-primary" data-bs-toggle="tooltip" data-bs-placement="top" title="Total number of log entries processed by the system">
            <div class="stat-card-icon">
                <i class="fas fa-file-alt"></i>
            </div>
            <div class="stat-card-body">
                <div class="stat-card-header">
                    <span class="stat-label">TOTAL LOGS</span>
                </div>
                <div class="stat-value" id="total-logs">{{ total_logs|default:"0" }}</div>
                <div class="stat-footer">
                    <span class="stat-badge stat-badge-success">
                        <i class="fas fa-arrow-up"></i> Processed
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-4 col-md-6">
        <div class="stat-card stat-card-danger" data-bs-toggle="tooltip" data-bs-placement="top" title="Number of log entries flagged as potential threats with anomaly score > threshold">
            <div class="stat-card-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-card-body">
                <div class="stat-card-header">
                    <span class="stat-label">ANOMALIES</span>
                </div>
                <div class="stat-value" id="total-anomalies">{{ total_anomalies|default:"0" }}</div>
                <div class="stat-footer">
                    <span class="stat-badge stat-badge-danger">
                        <i class="fas fa-exclamation-circle"></i> Detected
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-4 col-md-6">
        <div class="stat-card {% if system_status.overall == 'healthy' or system_status.overall == 'running' %}stat-card-success{% elif system_status.overall == 'degraded' or system_status.overall == 'warning' %}stat-card-warning{% else %}stat-card-danger{% endif %}" data-bs-toggle="tooltip" data-bs-placement="top" title="Overall system health including Kafka, database, and consumer status">
            <div class="stat-card-icon">
                <i class="fas fa-server"></i>
            </div>
            <div class="stat-card-body">
                <div class="stat-card-header">
                    <span class="stat-label">SYSTEM</span>
                </div>
                <div class="stat-value" id="system-status">
                    <span class="status-indicator status-{{ system_status.overall }}"></span>
                    {{ system_status.overall|title }}
                </div>
                <div class="stat-footer">
                    {% if system_status.overall == 'healthy' or system_status.overall == 'running' %}
                        <span class="stat-badge stat-badge-success">
                            <i class="fas fa-check-circle"></i> Operational
                        </span>
                    {% elif system_status.overall == 'degraded' or system_status.overall == 'warning' %}
                        <span class="stat-badge stat-badge-warning">
                            <i class="fas fa-exclamation-triangle"></i> Degraded
                        </span>
                    {% else %}
                        <span class="stat-badge stat-badge-danger">
                            <i class="fas fa-times-circle"></i> Stopped
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Real-time Anomaly Feed -->
<div class="row">
    <div class="col-12">
        <div class="content-card feed-card">
            <div class="feed-header">
                <div class="d-flex align-items-center">
                    <div class="feed-icon">
                        <i class="fas fa-broadcast-tower"></i>
                    </div>
                    <h5 class="mb-0 fw-bold">Real-time Anomaly Feed</h5>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <span class="badge badge-success-pulse" id="connection-status">
                        <i class="fas fa-circle me-1"></i>
                        Connected
                    </span>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshFeed()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh
                    </button>
                </div>
            </div>
            <div class="table-responsive" style="max-height: 650px; overflow-y: auto;">
                <table class="table table-hover modern-table mb-0">
                    <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                        <tr>
                            <th><i class="fas fa-clock me-2"></i>Timestamp</th>
                            <th><i class="fas fa-server me-2"></i>Host/IP</th>
                            <th><i class="fas fa-file-alt me-2"></i>Log Message</th>
                            <th><i class="fas fa-chart-line me-2"></i>Anomaly Score</th>
                            <th><i class="fas fa-flag me-2"></i>Status</th>
                        </tr>
                    </thead>
                    <tbody id="anomaly-feed">
                        {% for anomaly in recent_anomalies %}
                        <tr class="anomaly-row">
                            <td class="timestamp-cell">{{ anomaly.log_entry.timestamp|date:"n/j/Y, g:i:s A" }}</td>
                            <td>
                                <span class="host-badge">{{ anomaly.log_entry.host_ip }}</span>
                            </td>
                            <td>
                                <div class="log-message" title="{{ anomaly.log_entry.log_message }}">
                                    {{ anomaly.log_entry.log_message }}
                                </div>
                            </td>
                            <td>
                                <span class="score-badge score-{% if anomaly.anomaly_score > 0.8 %}high{% elif anomaly.anomaly_score > 0.6 %}medium{% else %}low{% endif %}">
                                    {{ anomaly.anomaly_score|floatformat:3 }}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge status-anomaly">Anomaly</span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="empty-state">
                                <div class="empty-state-content">
                                    <i class="fas fa-inbox"></i>
                                    <h5>No anomalies detected yet</h5>
                                    <p class="text-muted mb-0">The system is monitoring for anomalies</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- System Status Details -->
<div class="row mt-4">
    <div class="col-12">
        <div class="content-card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-cogs card-icon"></i>
                    System Status Details
                </h5>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                        <span class="status-indicator status-{{ system_status.kafka.status }}"></span>
                        <strong>Kafka Broker:</strong>
                        <span class="ms-2">{{ system_status.kafka.status|title }}</span>
                    </div>
                    <small class="text-muted">{{ system_status.kafka.details }}</small>
                </div>
                
                <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                        <span class="status-indicator status-{{ system_status.zookeeper.status }}"></span>
                        <strong>Zookeeper:</strong>
                        <span class="ms-2">{{ system_status.zookeeper.status|title }}</span>
                    </div>
                    <small class="text-muted">{{ system_status.zookeeper.details }}</small>
                </div>
                
                <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                        <span class="status-indicator status-{{ system_status.consumer.status }}"></span>
                        <strong>Consumer Process:</strong>
                        <span class="ms-2">{{ system_status.consumer.status|title }}</span>
                    </div>
                    <small class="text-muted">{{ system_status.consumer.details }}</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Real-time updates
let updateInterval;

function updateDashboard() {
    fetch('{% url "dashboard:api_dashboard_data" %}')
        .then(response => response.json())
        .then(data => {
            document.getElementById('total-logs').textContent = data.total_logs;
            document.getElementById('total-anomalies').textContent = data.total_anomalies;
            
            // Update system status
            const statusElement = document.getElementById('system-status');
            statusElement.innerHTML = `
                <span class="status-indicator status-${data.system_status.overall}"></span>
                ${data.system_status.overall.charAt(0).toUpperCase() + data.system_status.overall.slice(1)}
            `;
            
            // Update anomaly feed
            updateAnomalyFeed(data.recent_anomalies);
        })
        .catch(error => {
            console.error('Error updating dashboard:', error);
            document.getElementById('connection-status').className = 'badge bg-danger';
            document.getElementById('connection-status').innerHTML = '<i class="fas fa-circle me-1"></i>Disconnected';
        });
}

function updateAnomalyFeed(anomalies) {
    const tbody = document.getElementById('anomaly-feed');
    
    if (anomalies.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <br>
                    No anomalies detected yet
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = anomalies.map(anomaly => {
        // Determine badge color based on confidence level
        let statusBadge = 'bg-secondary';
        if (anomaly.status === 'Critical') {
            statusBadge = 'bg-danger';
        } else if (anomaly.status === 'High Confidence') {
            statusBadge = 'bg-warning text-dark';
        } else if (anomaly.status === 'Medium Confidence') {
            statusBadge = 'bg-info';
        } else if (anomaly.status === 'Low Confidence') {
            statusBadge = 'bg-secondary';
        } else {
            statusBadge = 'bg-light text-dark';
        }
        
        return `
            <tr>
                <td>${anomaly.timestamp}</td>
                <td><span class="badge bg-secondary">${anomaly.host_ip}</span></td>
                <td>
                    <div class="text-truncate" style="max-width: 300px;" title="${anomaly.log_message}">
                        ${anomaly.log_message}
                    </div>
                </td>
                <td>
                    <span class="badge ${anomaly.anomaly_score > 0.8 ? 'bg-danger' : anomaly.anomaly_score > 0.6 ? 'bg-warning' : 'bg-info'}">
                        ${parseFloat(anomaly.anomaly_score).toFixed(3)}
                    </span>
                </td>
                <td><span class="badge ${statusBadge}">${anomaly.status}</span></td>
            </tr>
        `;
    }).join('');
}

function refreshFeed() {
    updateDashboard();
}

// Load dashboard data on page load and set up auto-refresh based on user preferences
document.addEventListener('DOMContentLoaded', function() {
    updateDashboard();
    
    // Apply user's refresh interval preference
    const refreshInterval = {{ user_preferences.refresh_interval|default:0 }};
    if (refreshInterval > 0) {
        // Auto-refresh enabled based on user preferences
        updateInterval = setInterval(updateDashboard, refreshInterval * 1000);
        console.log(`Dashboard auto-refresh enabled: every ${refreshInterval} seconds`);
    } else {
        console.log('Dashboard auto-refresh disabled by user preference');
    }
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (updateInterval) {
        clearInterval(updateInterval);
    }
});

// Pipeline runner JS
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

async function startPipeline() {
    const btn = document.getElementById('run-pipeline-btn');
    btn.disabled = true;
    btn.textContent = 'Starting...';

    const csrftoken = getCookie('csrftoken');

    try {
        const res = await fetch('{% url "dashboard:run_pipeline" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Accept': 'application/json'
            },
            credentials: 'same-origin'
        });

        if (res.status === 409) {
            document.getElementById('pipeline-status').textContent = 'Status: Already running';
            btn.textContent = 'Run Demo Pipeline';
            btn.disabled = false;
            return;
        }

        const data = await res.json();
        if (data.status === 'started') {
            document.getElementById('pipeline-status').textContent = 'Status: Running';
            pollPipelineStatus();
            btn.textContent = 'Running...';
        } else {
            document.getElementById('pipeline-status').textContent = 'Status: ' + (data.status || 'unknown');
            btn.textContent = 'Run Demo Pipeline';
            btn.disabled = false;
        }
    } catch (e) {
        console.error('Pipeline start error', e);
        document.getElementById('pipeline-status').textContent = 'Status: Error starting pipeline';
        btn.textContent = 'Run Demo Pipeline';
        btn.disabled = false;
    }
}

let pipelinePollInterval = null;
async function pollPipelineStatus() {
    // Clear any existing poll
    if (pipelinePollInterval) {
        clearInterval(pipelinePollInterval);
    }

    const update = async () => {
        try {
            const res = await fetch('{% url "dashboard:pipeline_status" %}');
            const data = await res.json();
            const s = data.status || {};
            const statusText = s.status ? s.status : 'unknown';
            document.getElementById('pipeline-status').textContent = 'Status: ' + statusText;
            document.getElementById('pipeline-output').textContent = data.output_preview || '';

            if (s.status === 'completed' || s.status === 'failed') {
                clearInterval(pipelinePollInterval);
                const btn = document.getElementById('run-pipeline-btn');
                btn.disabled = false;
                btn.textContent = 'Run Demo Pipeline';
            }
        } catch (e) {
            console.error('Error fetching pipeline status', e);
        }
    };

    // Poll immediately and then every 10 seconds (reduced frequency for performance)
    update();
    pipelinePollInterval = setInterval(update, 10000);
}

document.getElementById('run-pipeline-btn').addEventListener('click', startPipeline);

// Initialize Bootstrap tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %} 