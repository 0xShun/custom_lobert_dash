{% extends 'base.html' %}

{% block title %}Dashboard - Log Anomaly Detection Platform{% endblock %}

{% block page_title %}Dashboard Overview{% endblock %}

{% block content %}
<!-- Summary Cards with Modern Design -->
<div class="row g-4 mb-5">
    <div class="col-xl-4 col-md-6">
        <div class="stat-card stat-card-primary" data-bs-toggle="tooltip" data-bs-placement="top" title="Total number of log entries processed by the system">
            <div class="stat-card-icon">
                <i class="fas fa-file-alt"></i>
            </div>
            <div class="stat-card-body">
                <div class="stat-card-header">
                    <span class="stat-label">TOTAL LOGS</span>
                </div>
                <div class="stat-value" id="total-logs">{{ total_logs|default:"0" }}</div>
                <div class="stat-footer">
                    <span class="stat-badge stat-badge-success">
                        <i class="fas fa-arrow-up"></i> Processed
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-4 col-md-6">
        <div class="stat-card stat-card-danger" data-bs-toggle="tooltip" data-bs-placement="top" title="Number of log entries flagged as potential threats with anomaly score > threshold">
            <div class="stat-card-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-card-body">
                <div class="stat-card-header">
                    <span class="stat-label">ANOMALIES</span>
                </div>
                <div class="stat-value" id="total-anomalies">{{ total_anomalies|default:"0" }}</div>
                <div class="stat-footer">
                    <span class="stat-badge stat-badge-danger">
                        <i class="fas fa-exclamation-circle"></i> Detected
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-4 col-md-6">
        <div class="stat-card {% if system_status.overall == 'healthy' or system_status.overall == 'running' %}stat-card-success{% elif system_status.overall == 'degraded' or system_status.overall == 'warning' %}stat-card-warning{% else %}stat-card-danger{% endif %}" data-bs-toggle="tooltip" data-bs-placement="top" title="Overall system health including Kafka, database, and consumer status">
            <div class="stat-card-icon">
                <i class="fas fa-server"></i>
            </div>
            <div class="stat-card-body">
                <div class="stat-card-header">
                    <span class="stat-label">SYSTEM</span>
                </div>
                <div class="stat-value" id="system-status">
                    <span class="status-indicator status-{{ system_status.overall }}"></span>
                    {{ system_status.overall|title }}
                </div>
                <div class="stat-footer">
                    {% if system_status.overall == 'healthy' or system_status.overall == 'running' %}
                        <span class="stat-badge stat-badge-success">
                            <i class="fas fa-check-circle"></i> Operational
                        </span>
                    {% elif system_status.overall == 'degraded' or system_status.overall == 'warning' %}
                        <span class="stat-badge stat-badge-warning">
                            <i class="fas fa-exclamation-triangle"></i> Degraded
                        </span>
                    {% else %}
                        <span class="stat-badge stat-badge-danger">
                            <i class="fas fa-times-circle"></i> Stopped
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Real-time Anomaly Feed -->
<div class="row">
    <div class="col-12">
        <div class="content-card feed-card">
            <div class="feed-header">
                <div class="d-flex align-items-center">
                    <div class="feed-icon">
                        <i class="fas fa-broadcast-tower"></i>
                    </div>
                    <h5 class="mb-0 fw-bold">Real-time Anomaly Feed</h5>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <span class="badge badge-success-pulse" id="connection-status">
                        <i class="fas fa-circle me-1"></i>
                        Connected
                    </span>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshFeed()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh
                    </button>
                </div>
            </div>
            <div class="table-responsive" style="max-height: 650px; overflow-y: auto;">
                <table class="table table-hover modern-table mb-0">
                    <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                        <tr>
                            <th><i class="fas fa-clock me-2"></i>Timestamp</th>
                            <th><i class="fas fa-server me-2"></i>Host/IP</th>
                            <th><i class="fas fa-file-alt me-2"></i>Log Message</th>
                            <th><i class="fas fa-chart-line me-2"></i>Anomaly Score</th>
                            <th><i class="fas fa-flag me-2"></i>Status</th>
                            <th class="text-center"><i class="fas fa-cog me-2"></i>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="anomaly-feed">
                        {% for anomaly in recent_anomalies %}
                        <tr class="anomaly-row">
                            <td class="timestamp-cell">{{ anomaly.timestamp|date:"n/j/Y, g:i:s A" }}</td>
                            <td>
                                <span class="host-badge">{{ anomaly.host_ip }}</span>
                            </td>
                            <td>
                                <div class="log-message" title="{{ anomaly.log_message }}">
                                    {{ anomaly.log_message }}
                                </div>
                            </td>
                            <td>
                                <span class="score-badge score-{% if anomaly.anomaly_score > 0.8 %}high{% elif anomaly.anomaly_score > 0.6 %}medium{% else %}low{% endif %}">
                                    {{ anomaly.anomaly_score|floatformat:3 }}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge status-anomaly">Anomaly</span>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-outline-primary rounded-pill" onclick="viewLogDetails({{ anomaly.log_entry_id }})" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="empty-state">
                                <div class="empty-state-content">
                                    <i class="fas fa-inbox"></i>
                                    <h5>No anomalies detected yet</h5>
                                    <p class="text-muted mb-0">The system is monitoring for anomalies</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- System Status Details -->
<div class="row mt-4">
    <div class="col-12">
        <div class="content-card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-cogs card-icon"></i>
                    System Status Details
                </h5>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                        <span class="status-indicator status-{{ system_status.kafka.status }}"></span>
                        <strong>Kafka Broker:</strong>
                        <span class="ms-2">{{ system_status.kafka.status|title }}</span>
                    </div>
                    <small class="text-muted">{{ system_status.kafka.details }}</small>
                </div>
                
                <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                        <span class="status-indicator status-{{ system_status.zookeeper.status }}"></span>
                        <strong>Zookeeper:</strong>
                        <span class="ms-2">{{ system_status.zookeeper.status|title }}</span>
                    </div>
                    <small class="text-muted">{{ system_status.zookeeper.details }}</small>
                </div>
                
                <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                        <span class="status-indicator status-{{ system_status.consumer.status }}"></span>
                        <strong>Consumer Process:</strong>
                        <span class="ms-2">{{ system_status.consumer.status|title }}</span>
                    </div>
                    <small class="text-muted">{{ system_status.consumer.details }}</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Details Modal -->
<div class="modal fade" id="logDetailsModal" tabindex="-1" aria-labelledby="logDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logDetailsModalLabel">
                    <i class="fas fa-file-alt me-2"></i>Log Entry Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="logDetailsContent">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Real-time updates
let updateInterval;
let previousAnomalyCount = 0;

function updateDashboard() {
    console.log('[Auto-refresh] Fetching anomaly feed and stats...');
    
    // Fetch anomaly feed HTML
    const feedPromise = fetch('{% url "dashboard:anomaly_feed_partial" %}', {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    }).then(response => {
        if (!response.ok) throw new Error(`Feed: HTTP ${response.status}`);
        return response.text();
    });
    
    // Fetch stats JSON
    const statsPromise = fetch('{% url "dashboard:dashboard_stats" %}', {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    }).then(response => {
        if (!response.ok) throw new Error(`Stats: HTTP ${response.status}`);
        return response.json();
    });
    
    // Wait for both requests
    Promise.all([feedPromise, statsPromise])
        .then(([html, stats]) => {
            console.log('[Auto-refresh] Data received:', stats.total_logs, 'logs,', stats.total_anomalies, 'anomalies');
            
            // Update connection status to connected
            document.getElementById('connection-status').className = 'badge badge-success-pulse';
            document.getElementById('connection-status').innerHTML = '<i class="fas fa-circle me-1"></i>Connected';
            
            // Update stats
            document.getElementById('total-logs').textContent = stats.total_logs;
            document.getElementById('total-anomalies').textContent = stats.total_anomalies;
            
            // Get current tbody
            const tbody = document.getElementById('anomaly-feed');
            
            // Count rows before update (excluding empty state)
            const currentRows = tbody.querySelectorAll('tr.anomaly-row');
            const currentCount = currentRows.length;
            
            // Update the table body
            tbody.innerHTML = html;
            
            // Count rows after update
            const newRows = tbody.querySelectorAll('tr.anomaly-row');
            const newCount = newRows.length;
            
            // Highlight new rows if count increased
            if (newCount > previousAnomalyCount && previousAnomalyCount > 0) {
                console.log(`[Auto-refresh] New anomalies detected: ${newCount - previousAnomalyCount}`);
                // Add highlight class to new rows (first N rows)
                const numNewRows = newCount - previousAnomalyCount;
                for (let i = 0; i < numNewRows && i < newRows.length; i++) {
                    newRows[i].classList.add('anomaly-row-new');
                }
                
                // Remove highlight after 2 seconds
                setTimeout(() => {
                    document.querySelectorAll('.anomaly-row-new').forEach(row => {
                        row.classList.remove('anomaly-row-new');
                    });
                }, 2000);
            }
            
            previousAnomalyCount = newCount;
        })
        .catch(error => {
            console.error('[Auto-refresh] Error:', error.message, error);
            document.getElementById('connection-status').className = 'badge bg-danger';
            document.getElementById('connection-status').innerHTML = '<i class="fas fa-circle me-1"></i>Disconnected';
        });
}

function refreshFeed() {
    updateDashboard();
}

// Load dashboard data on page load and set up auto-refresh (2-second interval for anomaly feed)
document.addEventListener('DOMContentLoaded', function() {
    // Initial load - will set connection status based on success/failure
    updateDashboard();
    
    // Auto-refresh anomaly feed every 2 seconds (lightweight, only fetches new data)
    updateInterval = setInterval(updateDashboard, 2000);
    console.log('Anomaly feed auto-refresh enabled: every 2 seconds');
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (updateInterval) {
        clearInterval(updateInterval);
    }
});

// Pipeline runner JS
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

async function startPipeline() {
    const btn = document.getElementById('run-pipeline-btn');
    btn.disabled = true;
    btn.textContent = 'Starting...';

    const csrftoken = getCookie('csrftoken');

    try {
        const res = await fetch('{% url "dashboard:run_pipeline" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Accept': 'application/json'
            },
            credentials: 'same-origin'
        });

        if (res.status === 409) {
            document.getElementById('pipeline-status').textContent = 'Status: Already running';
            btn.textContent = 'Run Demo Pipeline';
            btn.disabled = false;
            return;
        }

        const data = await res.json();
        if (data.status === 'started') {
            document.getElementById('pipeline-status').textContent = 'Status: Running';
            pollPipelineStatus();
            btn.textContent = 'Running...';
        } else {
            document.getElementById('pipeline-status').textContent = 'Status: ' + (data.status || 'unknown');
            btn.textContent = 'Run Demo Pipeline';
            btn.disabled = false;
        }
    } catch (e) {
        console.error('Pipeline start error', e);
        document.getElementById('pipeline-status').textContent = 'Status: Error starting pipeline';
        btn.textContent = 'Run Demo Pipeline';
        btn.disabled = false;
    }
}

let pipelinePollInterval = null;
async function pollPipelineStatus() {
    // Clear any existing poll
    if (pipelinePollInterval) {
        clearInterval(pipelinePollInterval);
    }

    const update = async () => {
        try {
            const res = await fetch('{% url "dashboard:pipeline_status" %}');
            const data = await res.json();
            const s = data.status || {};
            const statusText = s.status ? s.status : 'unknown';
            document.getElementById('pipeline-status').textContent = 'Status: ' + statusText;
            document.getElementById('pipeline-output').textContent = data.output_preview || '';

            if (s.status === 'completed' || s.status === 'failed') {
                clearInterval(pipelinePollInterval);
                const btn = document.getElementById('run-pipeline-btn');
                btn.disabled = false;
                btn.textContent = 'Run Demo Pipeline';
            }
        } catch (e) {
            console.error('Error fetching pipeline status', e);
        }
    };

    // Poll immediately and then every 10 seconds (reduced frequency for performance)
    update();
    pipelinePollInterval = setInterval(update, 10000);
}

document.getElementById('run-pipeline-btn').addEventListener('click', startPipeline);

// View log details function
function viewLogDetails(logId) {
    // Show loading state
    document.getElementById('logDetailsContent').innerHTML = `
        <div class="text-center py-4">
            <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
            <p class="mt-3 text-muted">Loading log details...</p>
        </div>
    `;
    
    // Show the modal
    var modal = new bootstrap.Modal(document.getElementById('logDetailsModal'));
    modal.show();
    
    // Fetch log details from API
    fetch(`/dashboard/api/log/${logId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const log = data.log;
                const anomalies = data.anomalies;
                
                // Build anomalies section
                let anomaliesHtml = '';
                if (anomalies.length > 0) {
                    anomaliesHtml = `
                        <div class="alert alert-warning mb-4" style="border-left: 4px solid #ffc107;">
                            <h6 class="mb-2"><i class="fas fa-exclamation-triangle me-2"></i>Anomalies Detected</h6>
                            ${anomalies.map(a => `
                                <div class="mt-2 pt-2 border-top">
                                    <strong>Score:</strong> ${a.score.toFixed(4)} 
                                    <span class="text-muted">(Threshold: ${a.threshold})</span>
                                    ${a.acknowledged ? '<span class="badge bg-success ms-2">Acknowledged</span>' : ''}
                                    <br>
                                    <small class="text-muted">Detected at: ${a.detected_at}</small>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    anomaliesHtml = `
                        <div class="alert alert-success mb-4" style="border-left: 4px solid #198754;">
                            <i class="fas fa-check-circle me-2"></i>No anomalies detected for this log entry
                        </div>
                    `;
                }
                
                // Build the details view
                document.getElementById('logDetailsContent').innerHTML = `
                    ${anomaliesHtml}
                    
                    <div class="mb-4">
                        <h6 class="text-primary mb-3 pb-2 border-bottom">
                            <i class="fas fa-info-circle me-2"></i>Log Information
                        </h6>
                        <dl class="row mb-0">
                            <dt class="col-sm-3 text-muted">Log ID:</dt>
                            <dd class="col-sm-9">${log.id}</dd>
                            
                            <dt class="col-sm-3 text-muted">Timestamp:</dt>
                            <dd class="col-sm-9">${log.timestamp}</dd>
                            
                            <dt class="col-sm-3 text-muted">Host/IP:</dt>
                            <dd class="col-sm-9">${log.host_ip}</dd>
                            
                            <dt class="col-sm-3 text-muted">Log Type:</dt>
                            <dd class="col-sm-9">
                                <span class="badge ${getLogTypeBadgeClass(log.log_type)}">
                                    <i class="fas ${getLogTypeIcon(log.log_type)} me-1"></i>
                                    ${log.log_type.toUpperCase()}
                                </span>
                            </dd>
                            
                            <dt class="col-sm-3 text-muted">Source:</dt>
                            <dd class="col-sm-9">${log.source}</dd>
                            
                            <dt class="col-sm-3 text-muted">Created At:</dt>
                            <dd class="col-sm-9">${log.created_at}</dd>
                        </dl>
                    </div>
                    
                    <div>
                        <h6 class="text-primary mb-3 pb-2 border-bottom">
                            <i class="fas fa-file-alt me-2"></i>Log Message
                        </h6>
                        <div class="p-3 bg-light border rounded" style="font-family: 'Courier New', monospace; white-space: pre-wrap; word-wrap: break-word;">
${log.log_message}
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('logDetailsContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Error loading log details: ${data.error}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error fetching log details:', error);
            document.getElementById('logDetailsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Failed to load log details. Please try again.
                </div>
            `;
        });
}

function getLogTypeBadgeClass(logType) {
    const type = logType.toLowerCase();
    if (type === 'error') return 'bg-danger';
    if (type === 'warning') return 'bg-warning';
    if (type === 'info') return 'bg-info';
    if (type === 'debug') return 'bg-secondary';
    return 'bg-secondary';
}

function getLogTypeIcon(logType) {
    const type = logType.toLowerCase();
    if (type === 'error') return 'fa-exclamation-circle';
    if (type === 'warning') return 'fa-exclamation-triangle';
    if (type === 'info') return 'fa-info-circle';
    if (type === 'debug') return 'fa-bug';
    return 'fa-circle';
}

// Initialize Bootstrap tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %} 